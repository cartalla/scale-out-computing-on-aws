<!DOCTYPE html>
<html lang="en">

<head>
     {% include 'common/header.html' %}

    <script src="{{ url_for('static', filename='vendor/jquery-formbuilder/form-render.min.js') }}"></script>
    <script src="{{ url_for('static', filename='vendor/jquery-ui/jquery-ui.min.js') }}"></script>
</head>

<body id="page-top">

  <div id="wrapper">
    {% include 'common/vertical_menu_bar.html' %}
    <div id="content-wrapper" class="d-flex flex-column">
      <div id="content">
          <br>
          <div class="container-fluid">
              {% include 'common/horizontal_menu_bar.html' %}
              <main role="main">
              {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <br>
                                {% if category == "success" %}
                                <div class="alert alert-success">
                                    <strong>{{ message | safe }} </strong>
                                </div>
                                {% else %}
                                 <div class="alert alert-danger">
                                    <strong>{{ message | safe }} </strong>
                                </div>
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    {% endwith %}

                  <div class="row">
                      <div class="col-md-6">
                          <div class="card shadow mb-4" style="width: 100%">
                              <div class="card-header py-3">
                                  <h6 class="m-0 font-weight-bold text-primary">Launching your {{ profile_name }} simulation </h6>
                              </div>
                              <div class="card-body">
                                  <form action="/submit_job/send" method="post">
                                      <div class="form-build"></div>
                                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                      <input type="hidden" name="job_script" value="{{ profile_job }}">
                                      <button type="submit" class="btn btn-success"><i class="fas fa-play"></i> Submit job</button>
                                  </form>
                              </div>
                          </div>
                      </div>
                      <div class="col-md-6">
                          <div class="card shadow mb-4" style="width: 100%">
                              <div class="card-header py-3">
                                  <h6 class="m-0 font-weight-bold text-primary">Cost Estimate</h6>
                              </div>
                              <div class="card-body">
                                  <div id="cost_result">
                                      <h3>
                                          Please fill out the form first
                                      </h3>
                                  </div>
                                  <hr>
                                  <p>
                                      <a data-toggle="collapse" href="#disclaimer" role="button" aria-expanded="false" aria-controls="collapseExample">
                                          Disclaimer: Baseline numbers
                                      </a>
                                  </p>
                                  <div class="collapse" id="disclaimer">
                                      <div class="card card-body">
                                          Theses numbers are just an estimate based on:
                                  <li>Virginia rates (us-east-1)</li>
                                  <li>Does not reflect any additional charges such as network or storage transfer or usage of io1 volume (default to gp2)</li>
                                  <li>FSx Persistent Baseline: (50 MB/s/TiB baseline, up to 1.3 GB/s/TiB burst)</li>
                                  <li>FSx Scratch Baseline: (200 MB/s/TiB baseline, up to 1.3 GB/s/TiB burst)</li>
                                  <li>Rate as of May 2020</li>  </div>
                                  </div>

                              </div>
                          </div>
                      </div>
                  </div>

              </main>





      </div>

    </div>
  </div>
</div>




              </div>
          </div>
      </div>

  </div>

  <a class="scroll-to-top rounded" href="#page-top">
    <i class="fas fa-angle-up"></i>
  </a>

  <script>

      $(document).ready(function(){
          formBuilder = $('.form-build').formRender({
              dataType: 'json',
              formData: {{ profile_form | safe }}
          })


         $("form").change(function(){
              var instance_type = $("#instance_type").val() || "c5.large";
              var ebs_storage = $("#ebs_storage").val() || 0;
              var fsx_storage = $("#fsx_storage").val() || 0;
              var wall_time = $("#wall_time").val() || 60;
              var cpus = $("#cpus").val() || 1;

             $("#cost_result").html('<h3><i class="fas fa-spinner"></i><br> Please wait while we estimate the price of this job ... </h3>'),

             $.get('/api/system/aws_price', {
                 "instance_type": instance_type,
                 "ebs_storage": ebs_storage,
                 "fsx_storage": fsx_storage,
                 "cpus": cpus,
                 "wall_time": wall_time
          }, function (data) {
                 cost_data = jQuery.parseJSON(JSON.stringify(data));
                 cost_ebs = cost_data.ebs_storage
                 cost_fsx = cost_data.fsx_storage
                 cost_compute_ondemand = cost_data.compute.estimated_on_demand_cost

                 var cost_response = '<h3>Estimated OnDemand Cost: $'+ cost_data.estimated_total_cost + '</h3> <br> \
                     <h3>Breakdown</h3> \
                     <div class="progress"> \
                     <div class="progress-bar bg-primary" role="progressbar" style="width: '+ cost_data.compute_pct +'%" aria-valuenow="'+ cost_data.compute_pct +'" aria-valuemin="0" aria-valuemax="100">Compute ($' + cost_data.compute.estimated_on_demand_cost + ')</div> \
                     <div class="progress-bar bg-success" role="progressbar" style="width: '+ cost_data.storage_pct +'%" aria-valuenow="'+ cost_data.storage_pct +'" aria-valuemin="0" aria-valuemax="100">Storage ($' + cost_data.estimated_storage_cost  + ')</div> \
                     </div> <br>\
                     <strong>Storage (EBS):</strong> '+ cost_data.ebs_storage +' <br>\
                     <strong>Storage (FSX):</strong> '+ cost_data.fsx_storage +' <br>\
                     <strong>Compute (Nodes Count)</strong> '+ cost_data.compute.nodes +' <br>\
                     <strong>Compute (Instance Type):</strong> '+ cost_data.compute.instance_type +' <br> \
                     <strong>Compute (Requested CPUs):</strong> '+ cost_data.compute.cpus +' <br> \
                     <strong>Estimated run time (in minutes):</strong> '+ cost_data.compute.wall_time +' <br> \
                     <hr> \
                     <strong>Estimated Compute OnDemand</strong> '+ cost_data.compute.estimated_on_demand_cost +' <br> \
                     <strong>Estimated Compute Reserved</strong> '+ cost_data.compute.estimated_reserved_cost +' <br>'

                 $("#cost_result").html(cost_response);

             }).fail(function(data) {
                 $("#cost_result").html("<h3><i class='fas fa-exclamation-triangle'></i>Unable to estimate cost</h3> Error: " + JSON.stringify(data.responseJSON));
             });
         });

      });



  </script>

    {% include 'common/footer.html' %}

</body>

</html>
